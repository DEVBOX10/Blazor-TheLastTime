@page "/"
@inject IIndexedDbFactory DbFactory

<div id="overlay-parent" class="container-fluid d-flex flex-grow-1">
    <div class="row flex-grow-1 py-2">
        <div class="col-sm-12 col-md-6">
            <fieldset>
                <EditForm Model="@newCategory" OnValidSubmit="@SaveNewCategory">
                    <InputText class="form-control form-control-sm" @bind-Value="@newCategory.Description" placeholder="Add new category..." />
                    <button type="submit" class="btn btn-sm btn-primary">Save</button>

                    <p><Microsoft.AspNetCore.Components.Forms.ValidationSummary /></p>
                    <DataAnnotationsValidator />
                </EditForm>
            </fieldset>

            <button class="btn btn-sm btn-primary" @onclick="@(() => {})">New</button>
            <button class="btn btn-sm btn-primary" @onclick="@(() => {})">Edit</button>

            @if (categoryList != null)
            {
                <fieldset>
                    <EditForm Model="@selectedCategory">
                        <InputSelect class="form-control form-control-sm" Value="@selectedCategory.Id" ValueExpression="@(() => selectedCategory.Id)" ValueChanged="async (long val) => { selectedCategory.Id = val; await LoadHabitList(); }">
                            <option value="0">All categories</option>
                            @foreach (var cat in categoryList)
                            {
                                <option value="@cat.Id">@cat.Description</option>
                            }
                        </InputSelect>

                        @if (selectedCategory.Id != 0)
                        {
                            <button class="btn btn-sm btn-primary" @onclick="@(() => DeleteCategory(selectedCategory))">Delete</button>
                        }
                    </EditForm>
                </fieldset>
            }

            @if (habitList != null)
            {
                <div class="card">
                    <div class="card-body">
                        accordion
                        @foreach (var habit in habitList)
                        {
                            <div class="d-flex">
                                <div class="flex-fill">@habit.Description</div>
                                <div class="flex-fill">@(habit.TimeList.Count > 0 ? habit.TimeList.Last().DateTime : "Never")</div>
                                <div class="m-1 ml-auto"><button class="btn btn-sm btn-primary" @onclick="@(() => DeleteHabit(habit))">Delete</button></div>
                                <div class="m-1"><button class="btn btn-sm btn-primary" @onclick="@(() => DoneHabit(habit))">Done</button></div>
                                <div class="m-1"><button class="btn btn-sm btn-primary" @onclick="@(() => selectedHabit = habit)">Details</button></div>
                                <div class="m-1"><button class="btn btn-sm btn-primary" @onclick="@(() => {})">Edit</button></div>
                            </div>
                        }
                    </div>
                </div>
            }

            <button class="btn btn-sm btn-primary" @onclick="@(() => {})">New</button>

            <fieldset>
                <EditForm Model="@newHabit" OnValidSubmit="@SaveNewHabit">
                    <InputText class="form-control form-control-sm" @bind-Value="@newHabit.Description" placeholder="Add new habit..." />
                    <button type="submit" class="btn btn-sm btn-primary">Save</button>

                    <p><Microsoft.AspNetCore.Components.Forms.ValidationSummary /></p>
                    <DataAnnotationsValidator />
                </EditForm>
            </fieldset>

            <InputFile class="form-control form-control-sm" OnChange="@ImportFile" />

            <p>
                @text
            </p>

            <button class="btn btn-sm btn-primary" @onclick="@(() => ExportFile())">Export</button>
        </div>
        @if (selectedHabit != null)
        {
            <div id="overlay" class="col-sm-12 col-md-6 d-flex">
                <div class="card flex-grow-1">
                    <div class="card-body">
                        @foreach (var time in timeList.Where(t => t.HabitId == selectedHabit.Id))
                        {
                            <div>@time.DateTime</div>

                            <button class="btn btn-sm btn-primary" @onclick="@(() => {})">Delete</button>
                            <button class="btn btn-sm btn-primary" @onclick="@(() => {})">Edit</button>
                            <button class="btn btn-sm btn-primary" @onclick="@(() => {})">Save</button>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>